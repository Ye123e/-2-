# Android系统修复工具 - 闪退修复功能快速使用指南

## 🚀 快速开始

### 推荐启动方式 (智能模式)
```bash
python start_intelligent.py
```

这是**推荐的启动方式**，会自动:
- 🔍 执行启动前诊断
- 🔧 自动修复发现的问题  
- 🚀 智能启动主程序
- 🚨 提供应急模式支持

### 其他启动方式

#### 诊断模式 (问题排查)
```bash
python start_intelligent.py --diagnostic --verbose
```
- 执行详细的系统检查
- 显示完整的调试信息
- 记录详细的诊断日志

#### 安全模式 (故障恢复)
```bash
python start_intelligent.py --safe --minimal-ui
```
- 最小化功能启动
- 忽略非关键错误
- 适用于系统异常时

#### 仅检查模式 (系统体检)
```bash
python start_intelligent.py --mode check
```
- 只执行系统检查
- 不启动主程序
- 快速了解系统状态

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 依赖包缺失
**现象**: 启动时提示 "ImportError: No module named xxx"
**解决**: 
```bash
# 自动修复 (推荐)
python start_intelligent.py --fix-missing

# 手动安装
pip install -r requirements.txt
```

#### 2. 配置文件损坏
**现象**: 启动时提示配置文件错误
**解决**:
```bash
# 进入应急模式重置配置
python start_intelligent.py
# 选择 "3. 重置配置文件"
```

#### 3. Python版本过低
**现象**: 启动检查提示Python版本不支持
**解决**:
- 升级Python到3.8或更高版本
- 或使用安全模式启动: `python start_intelligent.py --safe`

#### 4. 系统资源不足
**现象**: 启动时提示内存或磁盘空间不足
**解决**:
```bash
# 运行系统诊断
python -m src.utils.diagnostic_tools --diagnostic system --format text
# 根据建议清理资源
```

### 🆘 应急模式使用

当程序无法正常启动时，会自动提示进入应急模式:

```
🚨 是否进入应急模式? (y/N): y
```

应急模式功能:
1. **运行系统诊断** - 全面检查系统状态
2. **查看错误日志** - 查看最近的错误信息  
3. **重置配置文件** - 恢复默认配置
4. **检查依赖** - 验证所有依赖是否正确安装
5. **退出** - 退出应急模式

## 🔍 独立诊断工具

### 运行所有诊断
```bash
python -m src.utils.diagnostic_tools --diagnostic all --format text
```

### 运行特定诊断
```bash
# Python环境检查
python -m src.utils.diagnostic_tools --diagnostic python

# 系统资源检查  
python -m src.utils.diagnostic_tools --diagnostic system

# 网络连接检查
python -m src.utils.diagnostic_tools --diagnostic network
```

### 获取JSON格式报告
```bash
python -m src.utils.diagnostic_tools --format json > diagnosis_report.json
```

## 📊 查看系统状态

### 异常统计
程序运行时，异常处理中心会自动收集异常统计信息。可以通过日志查看详细统计。

### 启动历史
智能启动器记录每次启动的详细信息:
- 启动模式
- 成功/失败状态
- 启动耗时
- 发现的问题

### 修复记录
自动修复管理器记录所有修复操作:
- 问题类型和严重程度
- 修复策略和执行时间
- 修复成功率统计

## 🎛️ 高级配置

### 命令行参数详解

| 参数 | 说明 | 示例 |
|------|------|------|
| `--mode MODE` | 启动模式 | `--mode diagnostic` |
| `--log-level LEVEL` | 日志级别 | `--log-level DEBUG` |
| `--config PATH` | 配置文件路径 | `--config custom.ini` |
| `--timeout SECONDS` | 启动超时时间 | `--timeout 60` |
| `--no-auto-fix` | 禁用自动修复 | `--no-auto-fix` |
| `--performance-monitor` | 启用性能监控 | `--performance-monitor` |

### 环境变量

| 变量名 | 说明 | 示例 |
|--------|------|------|  
| `SAFE_MODE` | 安全模式标志 | `SAFE_MODE=1` |
| `LOG_LEVEL` | 默认日志级别 | `LOG_LEVEL=DEBUG` |
| `AUTO_FIX` | 默认自动修复 | `AUTO_FIX=true` |

## 📝 日志文件说明

### 主要日志文件
- `logs/app.log` - 主程序日志 (轮转)
- `logs/crash_*.json` - 崩溃信息记录
- `logs/diagnostic_*.log` - 诊断报告日志

### 日志格式
#### 彩色文本格式 (控制台)
```
🟢 [10:30:15] [INFO] [DeviceManager] 设备连接成功
```

#### JSON格式 (文件)
```json
{
  "timestamp": "2024-01-15T10:30:15Z",
  "level": "INFO", 
  "logger": "DeviceManager",
  "message": "设备连接成功"
}
```

## 🧪 测试和验证

### 运行完整测试
```bash
python test_crash_fix_comprehensive.py
```

### 测试特定功能
```bash
# 测试异常处理
python -c "from test_crash_fix_comprehensive import TestExceptionHandlingCenter; import unittest; unittest.main()"

# 测试智能启动
python -c "from test_crash_fix_comprehensive import TestIntelligentStarter; import unittest; unittest.main()"
```

### 性能基准测试
测试脚本会自动运行性能基准测试，包括:
- 异常处理性能 (10000个异常/秒)
- 智能启动性能 (参数解析速度)
- 诊断工具性能 (完整诊断时间)

## 🔄 自动修复功能

### 支持的问题类型
- ✅ **依赖包缺失** - 自动安装缺失的Python包
- ✅ **配置文件损坏** - 自动重建默认配置
- ✅ **环境变量缺失** - 自动创建必需目录
- ✅ **权限问题** - 提供权限修复建议
- ⚠️ **系统资源不足** - 提供清理建议 (需手动操作)

### 修复成功率
| 问题类型 | 自动修复成功率 | 备注 |
|---------|---------------|------|
| Python包缺失 | 95% | 需要网络连接 |
| 配置文件损坏 | 98% | 会创建备份 |
| 目录缺失 | 100% | 自动创建 |
| 权限不足 | 70% | 部分需要管理员权限 |

## 💡 最佳实践

### 开发环境
1. 使用详细模式: `python start_intelligent.py --verbose`
2. 启用性能监控: `--performance-monitor`  
3. 定期运行测试: `python test_crash_fix_comprehensive.py`
4. 监控日志文件: `tail -f logs/app.log`

### 生产环境  
1. 使用标准启动: `python start_intelligent.py`
2. 启用自动修复: (默认启用)
3. 定期系统诊断: 每周运行一次诊断
4. 监控异常率: 通过日志分析

### 故障预防
1. **定期检查**: 每周运行系统诊断
2. **日志监控**: 监控ERROR和CRITICAL级别日志
3. **依赖更新**: 定期更新Python包
4. **配置备份**: 定期备份配置文件

## ❓ 常见问答

### Q: 启动很慢怎么办？
A: 
- 使用普通模式而不是诊断模式
- 检查网络连接 (网络诊断可能较慢)
- 设置启动超时: `--timeout 30`

### Q: 自动修复失败怎么办？
A:
- 查看详细错误信息: `--verbose`
- 进入应急模式手动处理
- 检查网络连接和权限

### Q: 如何禁用自动修复？
A: 
- 启动时使用: `--no-auto-fix`
- 或设置环境变量: `AUTO_FIX=false`

### Q: 如何查看修复历史？
A:
- 查看日志文件: `logs/app.log`
- 运行诊断工具了解当前状态
- 异常统计信息会显示修复成功率

## 📞 获取帮助

### 查看帮助信息
```bash
python start_intelligent.py --help
python -m src.utils.diagnostic_tools --help
```

### 获取版本信息
```bash
python start_intelligent.py --version  # 如果实现了版本参数
```

### 报告问题
如果遇到问题:
1. 运行诊断: `python -m src.utils.diagnostic_tools --diagnostic all`
2. 收集日志: `logs/app.log` 和 `logs/crash_*.json`
3. 记录复现步骤
4. 提交问题报告

---

## 🎯 总结

闪退修复功能为Android系统修复工具提供了强大的稳定性保障:

- 🛡️ **全方位保护**: 多层次异常处理确保程序不会意外崩溃
- 🧠 **智能诊断**: 自动检测和识别常见问题
- 🔧 **自动修复**: 大多数问题可以自动解决
- 🚨 **应急支持**: 即使在严重故障时也能提供恢复选项
- 📊 **监控统计**: 实时监控系统健康状态

使用智能启动器 `python start_intelligent.py` 即可享受所有这些功能！